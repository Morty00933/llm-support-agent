# Обзор пользовательского интерфейса

Этот документ описывает структуру фронтенда и назначение полей на основных экранах приложения «LLM Support Agent».

## Технологический стек

- **React 18 + TypeScript.** Точка входа определена в `ui/src/main.tsx`, роутер объявлен в `ui/src/router.tsx`.
- **React Router.** Определяет маршруты `/login`, `/kb`, `/tickets`, `/agent`, `/settings` внутри общего макета.
- **Zustand.** Лёгкое хранилище состояния (`ui/src/store/auth.ts`) для данных авторизации и конфигурации API.
- **Tailwind CSS.** Используется для стилизации компонентов (utility-классы в JSX).

## Общий макет и навигация

### `Layout` (`ui/src/components/Layout.tsx`)

- Верхняя панель отображает название проекта и ссылки навигации на разделы KB, Tickets, Agent и Settings.
- В правой части шапки расположены:
  - **Поле `Tenant`** — числовой идентификатор арендатора. Изменение значения сразу обновляет глобальное состояние и заголовок `X-Tenant-Id` в запросах.
  - **Кнопка `Logout`** (если токен сохранён) — очищает хранилище и возвращает на страницу входа.
  - **Кнопка `Login`** (если токена нет) — отправляет пользователя на `/login`.
- Контент страницы отображается внутри `<Outlet/>`, поэтому навигационные ссылки загружают конкретные страницы внутри общего макета.

### `Guard` (`ui/src/components/Guard.tsx`)

- Оборачивает приватные маршруты. При отсутствии токена моментально перенаправляет пользователя на `/login`.

## Глобальное состояние авторизации (`ui/src/store/auth.ts`)

- **`token`** — JWT, сохраняемый в `localStorage` и используемый в заголовке `Authorization`.
- **`tenant`** — числовой идентификатор арендатора; хранится в `localStorage` и попадает в заголовок `X-Tenant-Id`.
- **`apiBase`** — базовый URL API. По умолчанию берётся из `VITE_API_BASE_URL`, затем из origin браузера. Хранится в `localStorage`.
- Методы `setToken`, `setTenant`, `setApiBase` синхронизируют значения с `localStorage`. Метод `reset` очищает токен и откатывает `apiBase` к значению по умолчанию.

## HTTP-клиент (`ui/src/lib/api.ts`)

- Функция `apiHeaders` собирает заголовки запроса, подставляя `Authorization` и `X-Tenant-Id`.
- Вспомогательная функция `request` добавляет префикс `/v1`, если базовый URL не заканчивается на `/v[0-9]`, и обрабатывает ошибки HTTP (включая автоматический выход при 401).
- Экспортируются наборы методов для доменов:
  - **`AuthAPI`** — вход пользователя (`/auth/login`).
  - **`KBAPI`** — upsert, поиск, архивация, удаление и реиндексация чанков знаний.
  - **`TicketsAPI`** — получение тикетов, создание, загрузка сообщений, отправка сообщений.
  - **`AgentAPI`** — свободный запрос к агенту и получение ответа по тикету.
- У каждого метода явно перечислены поля запроса, которые используются на соответствующих страницах UI.

## Страницы приложения

### 1. Login (`ui/src/pages/Login.tsx`)

Форма авторизации с автоматической подстановкой тестовых данных.

- **`Email`** — поле ввода логина. Значение сохраняется в локальном состоянии.
- **`Password`** — поле ввода пароля (тип `password`).
- При отправке формы вызывается `AuthAPI.login(email, password, tenant)`; `tenant` подхватывается из глобального состояния (можно заранее настроить в Layout или Settings).
- После успешной авторизации токен сохраняется (`setToken`) и пользователь перенаправляется на `/kb`.
- При ошибке показывается сообщение красным текстом.

### 2. Knowledge Base (`ui/src/pages/KB.tsx`)

Страница поделена на две колонки: левая отвечает за подготовку данных и загрузку в базу знаний, правая — за поиск и управление существующими чанками.

#### Левая колонка «Curate knowledge base»

- **`Source`** — строковый идентификатор источника (например, `docs`). При upsert передаётся как `payload.source`.
- **`Default language`** — язык по умолчанию для чанков (ISO-код). Пустое значение игнорируется, иначе попадает в `default_language` запроса.
- **`Default tags`** — список тегов через запятую; перед загрузкой нормализуется (пробелы удаляются, регистр приводится к нижнему). Отправляется как `default_tags`.
- **Блоки чанков** (список, каждый в отдельной карточке):
  - **`Content`** — текст чанка. Пустые значения при отправке отбрасываются.
  - **`Language`** — необязательное поле языка для конкретного чанка (перекрывает значение по умолчанию).
  - **`Tags (comma separated)`** — индивидуальные теги для чанка. Преобразуются в массив строк.
  - **`Metadata fields`** — динамическая таблица ключ/значение:
    - Кнопка `+ Add field` добавляет новую пару.
    - Поле ключа (`Key`) — строка, очищается и проверяется на уникальность.
    - Поле значения (`Value`) — строка; поддерживает булевы, числовые и JSON-значения. Результат отображается в превью.
    - Кнопка `Remove` удаляет строку метаданных.
  - Под блоком отображается превью вычисленного JSON `metadata` и диагностические сообщения о дубликатах ключей или неверном JSON.
  - В верхнем правом углу карточки — кнопка `Remove`, позволяющая удалить весь черновик чанка (если остался хотя бы один).
- **`+ Add chunk`** — создаёт новый пустой черновик.
- **Кнопка `Upload`** — отправляет собранные данные через `KBAPI.upsert`. В ответе показываются статистики (`created`, `updated`, `skipped`). Ошибки отображаются красным блоком.

#### Правая колонка «Search & manage KB»

- **`query…`** — текст поискового запроса, уходит в `KBAPI.search`.
- **`Limit`** — количество результатов (1–50). Значение подставляется в `limit`.
- **`Source filter`**, **`Tags filter`**, **`Language filter`** — фильтры поиска; пустые строки не передаются.
- **Флажок `Include metadata`** — добавляет `include_metadata=true` к запросу и управляет отображением блока метаданных в выдаче.
- **Флажок `Include archived`** — добавляет `include_archived=true`.
- **Кнопка `Search`** — запускает поиск.
- Список результатов показывает метаинформацию (source, score, similarity, даты, статус архивации), текст чанка и метаданные (язык, теги, количество символов/слов, качество).
- Для каждого результата доступны действия:
  - **`Reindex`** — вызывает `KBAPI.reindex` для одного чанка (включая архивные).
  - **`Archive` / `Restore`** — переключает статус через `KBAPI.archive`.
  - **`Delete`** — удаляет чанк через `KBAPI.remove`.
- Сообщения об ошибках и успехе отображаются под блоком.

### 3. Tickets (`ui/src/pages/Tickets.tsx`)

Страница работы с обращениями поделена на две части.

#### Левая колонка (список тикетов)

- **Поле ввода названия** — текстовый инпут для нового тикета. Если оставить пустым, при создании подставится «New ticket».
- **Кнопка `Create`** — вызывает `TicketsAPI.create`, добавляет тикет в начало списка и делает его активным.
- **Список тикетов** — кликабельный список с заголовком и статусом. Выбор тикета загружает сообщения через `TicketsAPI.messages`.

#### Правая колонка (детали тикета)

- **Лента сообщений** — прокручиваемая область, отображающая роль (`user`, `agent`, `system`) и текст.
- **Поле `Ваше сообщение…`** — ввод текста для пользователя. Пустая строка блокирует кнопку.
- **Кнопка `Send`** — отправляет сообщение через `TicketsAPI.addMessage`.
- **Секция «Вопрос агенту»**:
  - Поле ввода вопроса (по умолчанию «Опиши шаги решения»).
  - Кнопка `Ask Agent` — вызывает `AgentAPI.answerTicket` с параметрами `save=true`, `kb_limit=5`, `temperature=0.2` и обновляет ленту сообщений.
- В нижней части отображается текст ошибки, если запрос завершился неудачно.

### 4. Agent (`ui/src/pages/Agent.tsx`)

- **Поле вопроса** — свободный текст, который отправляется в `AgentAPI.ask` (по умолчанию «How to reset my password?»).
- **Кнопка `Ask`** — отправляет запрос и блокирует кнопку до завершения.
- После успешного ответа:
  - Блок **Answer** — отображает текст ответа агента.
  - Блок метаданных показывает, был ли ответ эскалирован, текст причины, а также использованный контекст (`used_context`).
- Ошибки выводятся отдельным сообщением.

### 5. Settings (`ui/src/pages/Settings.tsx`)

- **`API Base`** — базовый URL сервера (например, `/api`). Кнопка `Save` фиксирует значение через `setApiBase`.
- **`Tenant ID`** — числовой идентификатор арендатора, сохраняется через `setTenant`.
- **`Save`** — применяет значения без перезагрузки страницы.
- **`Reload`** — обновляет вкладку браузера (полезно после изменения переменных окружения).
- Блок токена отображает текущий JWT и кнопку `Logout (clear token)` для очистки.

## Дополнительные детали

- Все сетевые запросы используют значение `apiBase` из настроек. По умолчанию во время разработки через Docker UI проксируется Nginx’ом на `api:8000`, поэтому базовый URL обычно `/api`.
- Поля форм и состояния часто инициализируются значениями по умолчанию, чтобы упростить демонстрацию: например, в Login подставлены тестовые `email` и `password`, на странице KB стартует один пустой чанк, а в Tickets вопрос к агенту заранее заполнен.
- Состояния загрузки (`busy`, `load`) блокируют интерактивные кнопки, предотвращая повторные запросы.
